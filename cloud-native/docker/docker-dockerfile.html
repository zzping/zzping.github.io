<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Dockerfile | 南风知我意</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/images/nf.png">
    <meta name="description" content="后端开发 南风知我意的个人网站">
    
    <link rel="preload" href="/assets/css/0.styles.d2a44814.css" as="style"><link rel="preload" href="/assets/js/app.fa9b922e.js" as="script"><link rel="preload" href="/assets/js/2.25cc5d58.js" as="script"><link rel="preload" href="/assets/js/13.0157e368.js" as="script"><link rel="prefetch" href="/assets/js/10.a87e3e41.js"><link rel="prefetch" href="/assets/js/11.0364ff90.js"><link rel="prefetch" href="/assets/js/12.311eca75.js"><link rel="prefetch" href="/assets/js/14.12ac4ad9.js"><link rel="prefetch" href="/assets/js/15.356aa848.js"><link rel="prefetch" href="/assets/js/16.bc1151d9.js"><link rel="prefetch" href="/assets/js/17.def4874d.js"><link rel="prefetch" href="/assets/js/18.e350c724.js"><link rel="prefetch" href="/assets/js/19.e83e1d7c.js"><link rel="prefetch" href="/assets/js/20.c97de166.js"><link rel="prefetch" href="/assets/js/21.d2f7bd5c.js"><link rel="prefetch" href="/assets/js/22.41adaee0.js"><link rel="prefetch" href="/assets/js/23.799354b2.js"><link rel="prefetch" href="/assets/js/24.95fca6d6.js"><link rel="prefetch" href="/assets/js/25.465e8b94.js"><link rel="prefetch" href="/assets/js/26.16f7559c.js"><link rel="prefetch" href="/assets/js/27.ff4ffb1f.js"><link rel="prefetch" href="/assets/js/28.044518d6.js"><link rel="prefetch" href="/assets/js/29.dd693b24.js"><link rel="prefetch" href="/assets/js/3.ac93ca0a.js"><link rel="prefetch" href="/assets/js/30.962c7f0b.js"><link rel="prefetch" href="/assets/js/31.ed040a46.js"><link rel="prefetch" href="/assets/js/32.173e5f2d.js"><link rel="prefetch" href="/assets/js/33.02ea8a18.js"><link rel="prefetch" href="/assets/js/34.bb262992.js"><link rel="prefetch" href="/assets/js/35.896e9f41.js"><link rel="prefetch" href="/assets/js/36.1ddb7248.js"><link rel="prefetch" href="/assets/js/37.334aca7d.js"><link rel="prefetch" href="/assets/js/38.c0b524c3.js"><link rel="prefetch" href="/assets/js/39.1fa89074.js"><link rel="prefetch" href="/assets/js/4.ffc5bef0.js"><link rel="prefetch" href="/assets/js/40.d6313086.js"><link rel="prefetch" href="/assets/js/41.3f1e2bbd.js"><link rel="prefetch" href="/assets/js/42.29fd018f.js"><link rel="prefetch" href="/assets/js/43.3f4c39b8.js"><link rel="prefetch" href="/assets/js/44.7ecbe764.js"><link rel="prefetch" href="/assets/js/45.bec8ffa7.js"><link rel="prefetch" href="/assets/js/46.4d6373ca.js"><link rel="prefetch" href="/assets/js/47.a2c38019.js"><link rel="prefetch" href="/assets/js/48.36ff8bd5.js"><link rel="prefetch" href="/assets/js/49.d7349f0b.js"><link rel="prefetch" href="/assets/js/5.48532fea.js"><link rel="prefetch" href="/assets/js/50.3da1f291.js"><link rel="prefetch" href="/assets/js/51.45ef4844.js"><link rel="prefetch" href="/assets/js/52.8986512b.js"><link rel="prefetch" href="/assets/js/53.749813e1.js"><link rel="prefetch" href="/assets/js/54.96f2a134.js"><link rel="prefetch" href="/assets/js/55.4879e422.js"><link rel="prefetch" href="/assets/js/56.e8428beb.js"><link rel="prefetch" href="/assets/js/57.ca777ff0.js"><link rel="prefetch" href="/assets/js/58.dbb557db.js"><link rel="prefetch" href="/assets/js/59.df72912c.js"><link rel="prefetch" href="/assets/js/6.5eff19f1.js"><link rel="prefetch" href="/assets/js/60.d1ef93aa.js"><link rel="prefetch" href="/assets/js/61.b14ca761.js"><link rel="prefetch" href="/assets/js/62.2b179e3c.js"><link rel="prefetch" href="/assets/js/63.2f9c3889.js"><link rel="prefetch" href="/assets/js/64.9aa6d939.js"><link rel="prefetch" href="/assets/js/65.566da386.js"><link rel="prefetch" href="/assets/js/66.ce6ae55d.js"><link rel="prefetch" href="/assets/js/67.ba64f924.js"><link rel="prefetch" href="/assets/js/68.bfc2523e.js"><link rel="prefetch" href="/assets/js/69.1df26faa.js"><link rel="prefetch" href="/assets/js/7.100b5646.js"><link rel="prefetch" href="/assets/js/70.2063729c.js"><link rel="prefetch" href="/assets/js/71.ec1b8104.js"><link rel="prefetch" href="/assets/js/72.324f3a5e.js"><link rel="prefetch" href="/assets/js/73.17c953d3.js"><link rel="prefetch" href="/assets/js/74.0445d80d.js"><link rel="prefetch" href="/assets/js/75.d323dbb7.js"><link rel="prefetch" href="/assets/js/76.01731c02.js"><link rel="prefetch" href="/assets/js/77.040d470d.js"><link rel="prefetch" href="/assets/js/78.33374f69.js"><link rel="prefetch" href="/assets/js/79.5b3d3b01.js"><link rel="prefetch" href="/assets/js/8.298793bd.js"><link rel="prefetch" href="/assets/js/80.3d4ad376.js"><link rel="prefetch" href="/assets/js/81.7fa4543b.js"><link rel="prefetch" href="/assets/js/82.31832c90.js"><link rel="prefetch" href="/assets/js/83.291a632f.js"><link rel="prefetch" href="/assets/js/84.3efd8628.js"><link rel="prefetch" href="/assets/js/85.27beb273.js"><link rel="prefetch" href="/assets/js/86.d5228a1d.js"><link rel="prefetch" href="/assets/js/87.cad2873f.js"><link rel="prefetch" href="/assets/js/88.76fdf951.js"><link rel="prefetch" href="/assets/js/89.a9d71c3d.js"><link rel="prefetch" href="/assets/js/9.04671bc7.js"><link rel="prefetch" href="/assets/js/90.da55c751.js"><link rel="prefetch" href="/assets/js/91.0b29096c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d2a44814.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">南风知我意</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/java-core/exception.html" class="nav-link">
  Java核心基础
</a></div><div class="nav-item"><a href="/jvm/structure.html" class="nav-link">
  JVM学习
</a></div><div class="nav-item"><a href="/mybatis/mybatis-overview.html" class="nav-link">
  Mybatis
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring全家桶" class="dropdown-title"><span class="title">Spring全家桶</span> <span class="arrow down"></span></button> <button type="button" aria-label="Spring全家桶" class="mobile-dropdown-title"><span class="title">Spring全家桶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/spring-all/spring-framework/ioc-interface.html" class="nav-link">
  Spring Framework
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="拥抱云原生" class="dropdown-title"><span class="title">拥抱云原生</span> <span class="arrow down"></span></button> <button type="button" aria-label="拥抱云原生" class="mobile-dropdown-title"><span class="title">拥抱云原生</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cloud-native/cloud-native-concepts/" class="nav-link">
  云原生概念
</a></li><li class="dropdown-item"><!----> <a href="/cloud-native/docker/docker-overview/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/cloud-native/kubernetes/" class="nav-link">
  Kubernetes
</a></li><li class="dropdown-item"><!----> <a href="/cloud-native/devops/" class="nav-link">
  DevOps
</a></li></ul></div></div><div class="nav-item"><a href="/frontend/vue/vue-overview.html" class="nav-link">
  前端 - Vue
</a></div><div class="nav-item"><a href="/other/java8/why-java8.html" class="nav-link">
  零散知识
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/java-core/exception.html" class="nav-link">
  Java核心基础
</a></div><div class="nav-item"><a href="/jvm/structure.html" class="nav-link">
  JVM学习
</a></div><div class="nav-item"><a href="/mybatis/mybatis-overview.html" class="nav-link">
  Mybatis
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring全家桶" class="dropdown-title"><span class="title">Spring全家桶</span> <span class="arrow down"></span></button> <button type="button" aria-label="Spring全家桶" class="mobile-dropdown-title"><span class="title">Spring全家桶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/spring-all/spring-framework/ioc-interface.html" class="nav-link">
  Spring Framework
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="拥抱云原生" class="dropdown-title"><span class="title">拥抱云原生</span> <span class="arrow down"></span></button> <button type="button" aria-label="拥抱云原生" class="mobile-dropdown-title"><span class="title">拥抱云原生</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cloud-native/cloud-native-concepts/" class="nav-link">
  云原生概念
</a></li><li class="dropdown-item"><!----> <a href="/cloud-native/docker/docker-overview/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/cloud-native/kubernetes/" class="nav-link">
  Kubernetes
</a></li><li class="dropdown-item"><!----> <a href="/cloud-native/devops/" class="nav-link">
  DevOps
</a></li></ul></div></div><div class="nav-item"><a href="/frontend/vue/vue-overview.html" class="nav-link">
  前端 - Vue
</a></div><div class="nav-item"><a href="/other/java8/why-java8.html" class="nav-link">
  零散知识
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>容器技术 Docker</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/cloud-native/docker/docker-overview.html" class="sidebar-link">Docker 概述</a></li><li><a href="/cloud-native/docker/docker-architecture.html" class="sidebar-link">Docker 架构</a></li><li><a href="/cloud-native/docker/docker-install.html" class="sidebar-link">Docker 安装</a></li><li><a href="/cloud-native/docker/docker-three-elements.html" class="sidebar-link">Docker 三要素</a></li><li><a href="/cloud-native/docker/docker-commands.html" class="sidebar-link">Docker 常用命令</a></li><li><a href="/cloud-native/docker/docker-data-persistent.html" class="sidebar-link">Docker 数据持久化</a></li><li><a href="/cloud-native/docker/docker-network.html" class="sidebar-link">Docker 网络</a></li><li><a href="/cloud-native/docker/docker-install-service.html" class="sidebar-link">Docker 安装常用的软件</a></li><li><a href="/cloud-native/docker/docker-dockerfile.html" aria-current="page" class="active sidebar-link">Dockerfile</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/cloud-native/docker/docker-dockerfile.html#dockerfile-是什么" class="sidebar-link">Dockerfile 是什么</a></li><li class="sidebar-sub-header"><a href="/cloud-native/docker/docker-dockerfile.html#dockerfile-语法" class="sidebar-link">Dockerfile 语法</a></li><li class="sidebar-sub-header"><a href="/cloud-native/docker/docker-dockerfile.html#dockerfile-构建镜像用法详解" class="sidebar-link">Dockerfile 构建镜像用法详解</a></li><li class="sidebar-sub-header"><a href="/cloud-native/docker/docker-dockerfile.html#使用-dockerfile-构建-springboot-应用" class="sidebar-link">使用 Dockerfile 构建 SpringBoot 应用</a></li><li class="sidebar-sub-header"><a href="/cloud-native/docker/docker-dockerfile.html#dockerfile-最佳实践" class="sidebar-link">Dockerfile 最佳实践</a></li></ul></li><li><a href="/cloud-native/docker/docker-compose.html" class="sidebar-link">Docker Compose</a></li><li><a href="/cloud-native/docker/docker-ui.html" class="sidebar-link">Docker 可视化工具</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="dockerfile"><a href="#dockerfile" class="header-anchor">#</a> Dockerfile</h1> <h2 id="dockerfile-是什么"><a href="#dockerfile-是什么" class="header-anchor">#</a> Dockerfile 是什么</h2> <p>Dockerfile 是 Docker 用来构建镜像的文本文件，它包含指定的指令和格式。可以通过 docker build 命令从Dockerfile</p> <p>中构建镜像。即 Dockerfile 是 docker 镜像的描述文件。</p> <p>Dockerfile 没有后缀，文件名就是 Dockerfile。</p> <blockquote><p>Dockerfile 使用手册: https://docs.docker.com/engine/reference/builder/
Dockerfile 最佳实践: https://docs.docker.com/develop/develop-images/dockerfile_best-practices/</p></blockquote> <p><img src="/images/docker/101-docker%E6%A0%B8%E5%BF%83%E6%93%8D%E4%BD%9C.png" alt="docker核心操作"></p> <p><code>为什么要存在 Dockerfile？</code></p> <blockquote><p>问题：</p> <p>dockerhub 已经提供了很多完善的镜像，要什么镜像都有，为什么还需要我们使用 Dockerfile 构建镜像呢？</p> <p>答案：</p> <p>我们不会构建官方已经构建好的镜像，我们是将自己开发的应用通过 Dockerfile 打包成镜像，方便将我们的应用以容器的方式运行。</p></blockquote> <h2 id="dockerfile-语法"><a href="#dockerfile-语法" class="header-anchor">#</a> Dockerfile 语法</h2> <table><thead><tr><th>保留字</th> <th>作用</th></tr></thead> <tbody><tr><td>FROM</td> <td>当前镜像是基于哪个镜像的 <code>第一个指令必须是FROM</code></td></tr> <tr><td>MAINTAINER</td> <td>镜像维护者的姓名和邮箱地址（deprecated，已经标记为废弃）</td></tr> <tr><td>RUN</td> <td>构建镜像时需要运行的指令</td></tr> <tr><td>EXPOSE</td> <td>当前容器对外暴露出的端口号</td></tr> <tr><td>WORKDIR</td> <td>指定在创建容器后，终端默认登录进来的工作目录，一个落脚点</td></tr> <tr><td>ENV</td> <td>用来在构建镜像过程中设置环境变量</td></tr> <tr><td>ADD</td> <td>将宿主机目录下的文件拷贝进镜像且ADD命令会自动处理URL和解压tar包</td></tr> <tr><td>COPY</td> <td>类似于ADD，拷贝文件和目录到镜像中<br>将从构建上下文目录中&lt;原路径&gt;的文件/目录复制到新的一层的镜像内的&lt;目标路径&gt;位置</td></tr> <tr><td>VOLUME</td> <td>容器数据卷，用于数据保存和持久化工作</td></tr> <tr><td>CMD</td> <td>指定一个容器启动时要运行的命令<br>Dockerfile中可以有多个CMD指令，但只有最后一个生效，CMD会被docker run之后的参数替换</td></tr> <tr><td>ENTRYPOINT</td> <td>指定一个容器启动时要运行的命令<br>ENTRYPOINT的目的和CMD一样，都是在指定容器启动程序及其参数</td></tr></tbody></table> <h3 id="from"><a href="#from" class="header-anchor">#</a> FROM</h3> <blockquote><p><code>FROM</code> 用来指定 Dockerfile 的基础镜像`。一个有效的 Dockerfile 文件的必须以 FROM 指令作为第一条非注释指令。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>FROM centos:7
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></blockquote> <h3 id="maintainer-deprecated"><a href="#maintainer-deprecated" class="header-anchor">#</a> MAINTAINER（Deprecated）</h3> <blockquote><p><code>MAINTAINER</code> 用来指定镜像的作者信息`，目前已经被废弃了。</p></blockquote> <h3 id="run"><a href="#run" class="header-anchor">#</a> RUN</h3> <blockquote><p><code>RUN</code> 用来在构建镜像的过程中执行一些 shell 命令`，有两种写法：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>写法一： RUN 后面直接写 shell 命令
RUN <span class="token builtin class-name">echo</span> <span class="token string">&quot;i love docker&quot;</span>

写法二： RNN 后面是数组形式
RUN <span class="token punctuation">[</span><span class="token string">&quot;echo&quot;</span>, <span class="token string">&quot;i love docker&quot;</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>RUN 后面跟 shell 命令时，可以通过反斜杠 \ 将 RUN 指令继续到下一行，例如考虑以下两行：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>RUN <span class="token builtin class-name">echo</span> <span class="token string">&quot;i love \
docker&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>简单测试一下 RUN 指令</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 拉取 centos:7 镜像作为基础镜像</span>
docker pull centos:7

<span class="token comment"># 新建一个空目录 并进入该目录</span>
<span class="token function">mkdir</span> dockerfile
<span class="token builtin class-name">cd</span> dockerfile

<span class="token comment"># 新建 Dockerfile 文件</span>
<span class="token function">vim</span> Dockerfile

<span class="token comment"># 在 Dockerfile 文件中添加如下内容</span>
FROM centos:7
RUN <span class="token string">'echo Hello Docker'</span>
RUN <span class="token string">'echo I Love \
Docker'</span>

<span class="token comment"># 编辑完成后 !wq 保存退出, 使用 docker build 指令构建镜像</span>
docker build -t mycentos7:01 <span class="token builtin class-name">.</span>

<span class="token comment"># 执行 docker build 命令时输出如下：</span>
Sending build context to Docker daemon  <span class="token number">2</span>.048kB
Step <span class="token number">1</span>/3 <span class="token builtin class-name">:</span> FROM centos:7
---<span class="token operator">&gt;</span> 8652b9f0cb4c
Step <span class="token number">2</span>/3 <span class="token builtin class-name">:</span> RUN <span class="token builtin class-name">echo</span> <span class="token string">'Hello Docker'</span>
---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> 68456a5293e2
Hello Docker
Removing intermediate container 68456a5293e2
---<span class="token operator">&gt;</span> 4a9da7141074
Step <span class="token number">3</span>/3 <span class="token builtin class-name">:</span> RUN <span class="token builtin class-name">echo</span> <span class="token string">'I Love Docker'</span>
---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> 992bf24f4888
I Love Docker
Removing intermediate container 992bf24f4888
---<span class="token operator">&gt;</span> 46ed511f4281
Successfully built 46ed511f4281
Successfully tagged mycentos7:01
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div></blockquote> <blockquote><p><code>EXPOST</code> 用来指定构建的镜像在运行为容器时对外暴露的端口，只有 EXPOSE 指定了某个端口，使用 docker run 运行的时候才能通过 -p 对该端口进行映射。可以指定端口是侦听 TCP 还是 UDP，如果未指定协议，则默认值为 TCP</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 不指定类型，默认是 tcp 端口</span>
EXPOST <span class="token number">80</span>

<span class="token comment"># 指定 udp 端口</span>
EXPOST <span class="token number">80</span>/udp

<span class="token comment"># 同时暴露 tcp 和 udp 的 80 端口</span>
EXPOST <span class="token number">80</span>/tcp
EXPOST <span class="token number">80</span>/udp

<span class="token comment"># 运行容器时候也可以指定端口类型</span>
docker run -p <span class="token number">80</span>:80/tcp -p <span class="token number">80</span>:80/udp <span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></blockquote> <h3 id="workdir"><a href="#workdir" class="header-anchor">#</a> WORKDIR</h3> <blockquote><p><code>WORKDIR</code>  可以来指定工作目录（或者称为当前目录），以后各层的当前目录就被改为指定的目录，如该目录不存在，WORKDIR 会帮你建立目录。</p> <p>WORKDIR 指令可在 Dockerfile 中多次使用。 如果提供了相对路径，则它将相对于上一个WORKDIR 指令的路径</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>WORKDIR /a
WORKDIR b
WORKDIR c
RUN <span class="token builtin class-name">pwd</span>

<span class="token comment"># 上面的指令执行后最终的输出是 /a/b/c</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>WORKDIR 指令可以解析以前使用 ENV 设置的环境变量。 您只能使用在 Dockerfile 中显式设置的环境变量。 例如：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>ENV <span class="token assign-left variable">DIRPATH</span><span class="token operator">=</span>/path
WORKDIR <span class="token variable">$DIRPATH</span>/<span class="token variable">$DIRNAME</span>
RUN <span class="token builtin class-name">pwd</span>

<span class="token comment"># 上面的指令执行后最终的输出是 /path/$DIRNAME</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></blockquote> <h3 id="copy"><a href="#copy" class="header-anchor">#</a> COPY</h3> <blockquote><p><code>COPY</code> 指令将从构建上下文目录中 <code>&lt;源路径&gt;</code> 的文件/目录复制到新的一层的镜像内的 <code>&lt;目标路径&gt;</code> 位置。比如：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>COPY package.json /usr/src/app/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>&lt;源路径&gt;</code> 可以是多个，甚至可以是通配符，其通配符规则要满足 Go 的 <a href="https://golang.org/pkg/path/filepath/#Match" target="_blank" rel="noopener noreferrer"><code>filepath.Match</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 规则，如：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>COPY hom* /mydir/
COPY hom?.txt /mydir/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>&lt;目标路径&gt;</code> 可以是容器内的绝对路径，也可以是相对于工作目录的相对路径（工作目录可以用 <code>WORKDIR</code> 指令来指定）。目标路径不需要事先创建，如果目录不存在会在复制文件前先行创建缺失目录。</p> <p>此外，还需要注意一点，使用 <code>COPY</code> 指令，源文件的各种元数据都会保留。比如读、写、执行权限、文件变更时间等。这个特性对于镜像定制很有用。特别是构建相关文件都在使用 Git 进行管理的时候。</p></blockquote> <h3 id="add"><a href="#add" class="header-anchor">#</a> ADD</h3> <blockquote><p><code>ADD</code> 指令和 <code>COPY</code> 的格式和性质基本一致。但是在 <code>COPY</code> 基础上增加了一些功能。</p> <p>如果 <code>&lt;源路径&gt;</code> 为一个 <code>tar</code> 压缩文件的话，压缩格式为 <code>gzip</code>, <code>bzip2</code> 以及 <code>xz</code> 的情况下，<code>ADD</code> 指令将会自动解压缩这个压缩文件到 <code>&lt;目标路径&gt;</code> 去。</p> <p>比如 <code>&lt;源路径&gt;</code> 可以是一个 <code>URL</code>，这种情况下，Docker 引擎会试图去下载这个链接的文件放到 <code>&lt;目标路径&gt;</code> 去。下载后的文件权限自动设置为 <code>600</code>，如果这并不是想要的权限，那么还需要增加额外的一层 <code>RUN</code> 进行权限调整，另外，如果下载的是个压缩包，需要解压缩，也一样还需要额外的一层 <code>RUN</code> 指令进行解压缩。所以不如直接使用 <code>RUN</code> 指令，然后使用 <code>wget</code> 或者 <code>curl</code> 工具下载，处理权限、解压缩、然后清理无用文件更合理。因此，这个功能其实并不实用，而且不推荐使用。</p> <p>在 Docker 官方的 <a href="https://www.bookstack.cn/read/docker-practice/appendix-best_practices.md" target="_blank" rel="noopener noreferrer">Dockerfile 最佳实践文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 中要求，尽可能的使用 <code>COPY</code>，因为 <code>COPY</code> 的语义很明确，就是复制文件而已，而 <code>ADD</code> 则包含了更复杂的功能，其行为也不一定很清晰。最适合使用 <code>ADD</code> 的场合，就是所提及的需要自动解压缩的场合。</p></blockquote> <h3 id="volume"><a href="#volume" class="header-anchor">#</a> VOLUME</h3> <blockquote><p>TODO</p></blockquote> <h3 id="cmd"><a href="#cmd" class="header-anchor">#</a> CMD</h3> <blockquote><p><code>CMD</code> 指令就是用于指定默认的容器主进程的启动命令的。因为 Docker 不是虚拟机，容器就是进程。既然是进程，那么在启动容器的时候，需要指定所运行的程序及参数。它也有两种格式：</p> <ul><li><code>shell</code> 格式：CMD &lt;命令&gt;</li> <li><code>exec</code> 格式：CMD [&quot;可执行文件&quot;, &quot;参数1&quot;, &quot;参数2&quot;...]</li></ul> <p>在运行时可以指定新的命令来替代镜像设置中的这个默认命令，比如，<code>ubuntu</code> 镜像默认的 <code>CMD</code> 是 <code>/bin/bash</code>，如果我们直接 <code>docker run -it ubuntu</code> 的话，会直接进入 <code>bash</code>。我们也可以在运行时指定运行别的命令，如 <code>docker run -it ubuntu cat /etc/os-release</code>。这就是用 <code>cat /etc/os-release</code> 命令替换了默认的 <code>/bin/bash</code> 命令了，输出了系统版本信息。</p> <p>在指令格式上，一般推荐使用 <code>exec</code> 格式，这类格式在解析时会被解析为 JSON 数组，因此一定要使用双引号 <code>&quot;</code>，而不要使用单引号。</p> <p>如果使用 <code>shell</code> 格式的话，实际的命令会被包装为 <code>sh -c</code> 的参数的形式进行执行。比如：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>CMD echo $HOME
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在实际执行中，会将其变更为：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>CMD [ &quot;sh&quot;, &quot;-c&quot;, &quot;echo $HOME&quot; ]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这就是为什么我们可以使用环境变量的原因，因为这些环境变量会被 shell 进行解析处理。</p></blockquote> <h3 id="entrypoint"><a href="#entrypoint" class="header-anchor">#</a> ENTRYPOINT</h3> <blockquote><p>https://www.bookstack.cn/read/docker-practice/image-dockerfile-entrypoint.md</p> <p><code>ENTRYPOINT</code> 的格式和 <code>RUN</code> 指令格式一样，分为 <code>exec</code> 格式和 <code>shell</code> 格式。</p> <p><code>ENTRYPOINT</code> 的目的和 <code>CMD</code> 一样，都是在指定容器启动程序及参数。<code>ENTRYPOINT</code> 在运行时也可以替代，不过比 <code>CMD</code> 要略显繁琐，需要通过 <code>docker run</code> 的参数 <code>--entrypoint</code> 来指定。</p> <p>当指定了 <code>ENTRYPOINT</code> 后，<code>CMD</code> 的含义就发生了改变，不再是直接的运行其命令，而是将 <code>CMD</code> 的内容作为参数传给 <code>ENTRYPOINT</code> 指令，换句话说实际执行时，将变为：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token operator">&lt;</span>ENTRYPOINT<span class="token operator">&gt;</span> <span class="token string">&quot;&lt;CMD&gt;&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></blockquote> <h2 id="dockerfile-构建镜像用法详解"><a href="#dockerfile-构建镜像用法详解" class="header-anchor">#</a> Dockerfile 构建镜像用法详解</h2> <p><code>docker build</code> 命令基于 Dockerfile 和上下文构建镜像。构建的上下文有两个来源</p> <ul><li>PATH： 本地文件系统上的目录</li> <li>URL：Git 仓库的地址</li></ul> <p>通常我们会新建一个空目录，在空目录中新建 Dockerfile 文件，并把构建过程中需要的文件或者资源放在该目录下，这整个目录就是<code>构建的上下文</code>。</p> <p><code>docker build</code> 命令是由 Docker 的守护进程来执行，而不是 Docker CLI 的客户端。因此，<code>docker build</code> 命令的第一步是将构建上下文所在的整个目录下的所有资源文件及目录都进行打包，然后一起发送到 Docker daemon。由 Docker daemon 首先检查 Dockerfile 的语法，然后逐一执行 Dockerfile 文件的指令，每执行一条指令都会生成一个新的镜像。最后执行完生成一个最终镜像。</p> <p>![docker build命令执行的过程](images/13-docker build命令的执行过程.png)</p> <p>如果在构建上下文中希望忽略某些文件，不希望将某些文件打包发送达到 Docker daemon，可以在构建上下文目录下添加一个 <code>.dockerignore</code> 文件（类似 .gitignore 功能一样）用于排除某些文件。</p> <h2 id="使用-dockerfile-构建-springboot-应用"><a href="#使用-dockerfile-构建-springboot-应用" class="header-anchor">#</a> 使用 Dockerfile 构建 SpringBoot 应用</h2> <p>（1）开发一个简单的 Spring Boot 应用，请求 /hello，响应 &quot;Hello Docker&quot; 字符串。</p> <blockquote><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloController</span> <span class="token punctuation">{</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/hello&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Hello Docker!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token string">&quot;Hello Docker!&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></blockquote> <p>（2）将 Spring Boot 应用打包成 jar（demo-0.0.1-SNAPSHOT.jar） ，并上传到 linux 系统中 /root/apps 目录下</p> <p>（3）在 /root/apps 目录下新建一个 Dockerfile 文件</p> <blockquote><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /root/apps
<span class="token function">vim</span> Dockerfile

<span class="token comment"># 添加如下内容达到 Dockerfile 文件中</span>
FROM openjdk:8-jre
ADD demo-0.0.1-SNAPSHOT.jar demo.jar
EXPOSE <span class="token number">8081</span>
ENTRYPOINT <span class="token punctuation">[</span><span class="token string">&quot;java&quot;</span>, <span class="token string">&quot;-jar&quot;</span><span class="token punctuation">]</span>
CMD <span class="token punctuation">[</span><span class="token string">&quot;demo.jar&quot;</span><span class="token punctuation">]</span>

<span class="token comment"># !wq 保存退出, 然后使用 docker build 命令通过 Dockerfile 构建镜像</span>
docker build -t demo:01 <span class="token builtin class-name">.</span>

<span class="token comment"># 根据镜像运行容器</span>
docker run -p <span class="token number">8080</span>:8080 --name app01 -d demo:01

<span class="token comment"># 实时查看容器日志</span>
docker logs -f app01

<span class="token comment"># 浏览器访问 http://192.168.145.31:8080/hello</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div></blockquote> <h2 id="dockerfile-最佳实践"><a href="#dockerfile-最佳实践" class="header-anchor">#</a> Dockerfile 最佳实践</h2> <blockquote><p>官方文档： <a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/" target="_blank" rel="noopener noreferrer">Dockerfile最佳实践<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/cloud-native/docker/docker-install-service.html" class="prev">
        Docker 安装常用的软件
      </a></span> <span class="next"><a href="/cloud-native/docker/docker-compose.html">
        Docker Compose
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.fa9b922e.js" defer></script><script src="/assets/js/2.25cc5d58.js" defer></script><script src="/assets/js/13.0157e368.js" defer></script>
  </body>
</html>
